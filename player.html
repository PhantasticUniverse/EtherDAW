<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EtherDAW Player v0.9.5</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #e8e8e8;
    }
    .player {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .title { font-size: 28px; font-weight: 600; margin-bottom: 8px; color: #fff; }
    .composer { font-size: 16px; color: #8892b0; margin-bottom: 24px; }
    .meta { display: flex; gap: 24px; margin-bottom: 32px; font-size: 14px; color: #a8b2d1; }
    .meta span { display: flex; align-items: center; gap: 6px; }
    .progress-container { margin-bottom: 24px; }
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #64ffda, #48c9b0);
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #8892b0;
      margin-top: 8px;
    }
    .section-display {
      text-align: center;
      font-size: 14px;
      color: #64ffda;
      margin-bottom: 24px;
      height: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .controls { display: flex; justify-content: center; gap: 16px; margin-bottom: 32px; }
    .btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-play {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, #64ffda, #48c9b0);
      color: #1a1a2e;
    }
    .btn-play:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(100, 255, 218, 0.4);
    }
    .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #e8e8e8; }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
    .btn svg { width: 24px; height: 24px; }
    .btn-play svg { width: 32px; height: 32px; }
    .instruments { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .instrument {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      font-size: 12px;
      color: #a8b2d1;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.15s;
    }
    .instrument.active {
      background: rgba(100, 255, 218, 0.15);
      border-color: rgba(100, 255, 218, 0.4);
      color: #64ffda;
      box-shadow: 0 0 12px rgba(100, 255, 218, 0.2);
    }
    .loading { text-align: center; padding: 48px; }
    .loading p { color: #8892b0; }
    .click-prompt {
      margin-top: 24px;
      padding: 16px 32px;
      background: linear-gradient(135deg, #64ffda, #48c9b0);
      color: #1a1a2e;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .click-prompt:hover {
      transform: scale(1.02);
      box-shadow: 0 0 30px rgba(100, 255, 218, 0.4);
    }
    .description {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 13px;
      color: #8892b0;
      font-style: italic;
      text-align: center;
      line-height: 1.6;
    }
    .song-selector { margin-top: 20px; margin-bottom: 20px; }
    .song-selector label {
      display: block;
      font-size: 12px;
      color: #8892b0;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .song-selector select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e8e8e8;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238892b0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    .song-selector select:hover { border-color: rgba(100, 255, 218, 0.4); }
    .song-selector select:focus { border-color: #64ffda; box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2); }
    .song-selector select option { background: #1a1a2e; color: #e8e8e8; padding: 8px; }
    .track-display {
      position: relative;
      margin-bottom: 20px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }
    #note-canvas {
      display: block;
      width: 100%;
      height: 120px;
    }
    .track-labels {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 60px;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      padding: 8px 0;
      background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 70%, transparent 100%);
      pointer-events: none;
    }
    .track-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #8892b0;
      padding-left: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.1s, text-shadow 0.1s;
    }
    .track-label.active {
      color: #64ffda;
      text-shadow: 0 0 8px rgba(100, 255, 218, 0.6);
    }
    .hit-line {
      position: absolute;
      left: 60px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, transparent 0%, #64ffda 20%, #64ffda 80%, transparent 100%);
      opacity: 0.6;
    }
    .btn-export {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.4);
    }
    .btn-export:hover:not(:disabled) {
      background: rgba(255, 107, 107, 0.3);
      border-color: rgba(255, 107, 107, 0.6);
    }
    .btn-export:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-export svg { width: 20px; height: 20px; }
    .export-text { font-size: 10px; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .error { color: #ff6b6b; margin-top: 16px; font-size: 14px; }
    #player-ui { display: none; }
    .version { font-size: 11px; color: #4a5568; margin-top: 16px; text-align: center; }

    /* Section buttons */
    .section-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 24px;
    }
    .section-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      color: #a8b2d1;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .section-btn:hover {
      background: rgba(100, 255, 218, 0.1);
      border-color: rgba(100, 255, 218, 0.4);
      color: #64ffda;
    }
    .section-btn.active {
      background: rgba(100, 255, 218, 0.2);
      border-color: #64ffda;
      color: #64ffda;
      box-shadow: 0 0 12px rgba(100, 255, 218, 0.3);
    }
    .section-btn .section-index {
      font-size: 10px;
      opacity: 0.6;
      margin-right: 4px;
    }

    /* Tempo control */
    .tempo-control {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }
    .tempo-control label {
      font-size: 12px;
      color: #8892b0;
      min-width: 50px;
    }
    .tempo-slider {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }
    .tempo-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd93d, #fb923c);
      cursor: pointer;
      transition: transform 0.1s;
    }
    .tempo-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
    .tempo-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd93d, #fb923c);
      cursor: pointer;
      border: none;
    }
    .tempo-display {
      font-size: 14px;
      color: #ffd93d;
      min-width: 50px;
      text-align: right;
      font-weight: 600;
    }

    /* Keyboard shortcuts hint */
    .shortcuts-hint {
      font-size: 11px;
      color: #4a5568;
      margin-top: 12px;
      text-align: center;
    }
    .shortcuts-hint kbd {
      display: inline-block;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      font-family: monospace;
      font-size: 10px;
      margin: 0 2px;
    }
    .volume-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }
    .btn-mute {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #e8e8e8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-mute:hover { background: rgba(255, 255, 255, 0.2); }
    .btn-mute.muted { color: #ff6b6b; }
    .btn-mute svg { width: 20px; height: 20px; }
    .volume-slider {
      width: 120px;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #64ffda, #48c9b0);
      cursor: pointer;
      transition: transform 0.1s;
    }
    .volume-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
    .volume-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #64ffda, #48c9b0);
      cursor: pointer;
      border: none;
    }
    .volume-display {
      font-size: 12px;
      color: #8892b0;
      min-width: 35px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="player" id="player">
    <!-- Loading/Start Screen -->
    <div class="loading" id="loading">
      <h2 style="margin-bottom: 16px; color: #fff;">EtherDAW Player</h2>
      <p>Browser audio requires user interaction to start.</p>
      <div class="song-selector">
        <label for="song-select">Choose a composition</label>
        <select id="song-select"></select>
      </div>
      <button class="click-prompt" id="start-btn">Start Audio Engine</button>
      <div id="load-error" class="error" style="display: none;"></div>
      <div class="version">v0.9.5 - Player Controls</div>
    </div>

    <!-- Player UI (shown after start) -->
    <div id="player-ui">
      <h1 class="title" id="song-title">Loading...</h1>
      <p class="composer" id="song-composer"></p>
      <div class="meta">
        <span id="song-tempo"></span>
        <span id="song-key"></span>
        <span id="song-duration"></span>
      </div>

      <div class="track-display" id="track-display">
        <canvas id="note-canvas"></canvas>
        <div class="track-labels" id="track-labels"></div>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="time-display">
          <span id="current-time">0:00</span>
          <span id="total-time">0:00</span>
        </div>
      </div>

      <div class="section-display" id="section-display"></div>

      <div class="section-buttons" id="section-buttons"></div>

      <div class="controls">
        <button class="btn btn-secondary" id="stop-btn" title="Stop">
          <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg>
        </button>
        <button class="btn btn-play" id="play-btn" title="Play/Pause">
          <svg viewBox="0 0 24 24" fill="currentColor" id="play-icon"><polygon points="8,5 19,12 8,19"/></svg>
        </button>
        <button class="btn btn-secondary btn-export" id="export-btn" title="Export WAV">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
        </button>
      </div>

      <div class="volume-control">
        <button class="btn-mute" id="mute-btn" title="Mute">
          <svg viewBox="0 0 24 24" fill="currentColor" id="volume-icon">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </button>
        <input type="range" id="volume-slider" min="0" max="100" value="80" class="volume-slider">
        <span id="volume-display" class="volume-display">80%</span>
      </div>

      <div class="tempo-control">
        <label>Tempo</label>
        <input type="range" id="tempo-slider" min="50" max="200" value="100" class="tempo-slider">
        <span id="tempo-display" class="tempo-display">100%</span>
      </div>

      <div class="shortcuts-hint">
        <kbd>Space</kbd> play/pause
        <kbd>&larr;</kbd><kbd>&rarr;</kbd> seek
        <kbd>1</kbd>-<kbd>9</kbd> sections
        <kbd>Home</kbd> start
      </div>

      <div class="instruments" id="instruments"></div>

      <p class="description" id="song-description"></p>

      <div class="song-selector" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <label for="song-select-playing">Switch Composition</label>
        <select id="song-select-playing"></select>
      </div>
      <div id="player-error" class="error" style="display: none;"></div>
    </div>
  </div>

  <script type="module">
    // EtherDAW Player v0.9.5 - Player Controls: section buttons, tempo slider, keyboard shortcuts
    import * as EtherDAW from './dist/etherdaw-browser.js';

    // Make available globally for debugging
    window.EtherDAW = EtherDAW;

    // DOM elements
    const loadingEl = document.getElementById('loading');
    const playerUI = document.getElementById('player-ui');
    const startBtn = document.getElementById('start-btn');
    const playBtn = document.getElementById('play-btn');
    const stopBtn = document.getElementById('stop-btn');
    const exportBtn = document.getElementById('export-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const currentTimeEl = document.getElementById('current-time');
    const totalTimeEl = document.getElementById('total-time');
    const sectionDisplay = document.getElementById('section-display');
    const instrumentsEl = document.getElementById('instruments');
    const playIcon = document.getElementById('play-icon');
    const songSelect = document.getElementById('song-select');
    const songSelectPlaying = document.getElementById('song-select-playing');
    const loadError = document.getElementById('load-error');
    const playerError = document.getElementById('player-error');
    const trackDisplay = document.getElementById('track-display');
    const noteCanvas = document.getElementById('note-canvas');
    const noteCtx = noteCanvas.getContext('2d');
    const trackLabels = document.getElementById('track-labels');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeDisplay = document.getElementById('volume-display');
    const muteBtn = document.getElementById('mute-btn');
    const volumeIcon = document.getElementById('volume-icon');
    const sectionButtonsEl = document.getElementById('section-buttons');
    const tempoSlider = document.getElementById('tempo-slider');
    const tempoDisplayEl = document.getElementById('tempo-display');

    // Player instance
    let player = null;
    let animationId = null;
    let lastVolumeBeforeMute = 80;

    // Note display state
    let trackList = [];
    let trackColors = {};
    const NOTE_COLORS = [
      '#64ffda', '#ff6b6b', '#ffd93d', '#a78bfa',
      '#f472b6', '#34d399', '#60a5fa', '#fb923c'
    ];
    const LOOKAHEAD_SECONDS = 4; // How many seconds ahead to show
    const HIT_LINE_X = 60; // X position of the hit line

    // SVG icons (static, trusted content)
    const PLAY_ICON = '<polygon points="8,5 19,12 8,19"/>';
    const PAUSE_ICON = '<rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/>';
    const VOLUME_HIGH_ICON = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2" fill="none"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14" stroke="currentColor" stroke-width="2" fill="none"/>';
    const VOLUME_LOW_ICON = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2" fill="none"/>';
    const VOLUME_MUTE_ICON = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15" stroke="currentColor" stroke-width="2"/><line x1="17" y1="9" x2="23" y2="15" stroke="currentColor" stroke-width="2"/>';

    // Try to load manifest, fall back to hardcoded list
    async function loadCompositions() {
      try {
        const response = await fetch('./dist/manifest.json');
        if (response.ok) {
          const manifest = await response.json();
          return manifest.compositions;
        }
      } catch (e) {
        console.log('Manifest not found, using fallback list');
      }

      // Fallback list
      return [
        { path: 'examples/techno-machine-state.etherscore.json', title: 'Machine State (Minimal Techno)' },
        { path: 'examples/lofi-study.etherscore.json', title: 'Late Night Study (Lo-fi Hip Hop)' },
        { path: 'examples/convergence.etherscore.json', title: 'Convergence (Minimalist Ambient)' },
        { path: 'examples/emergence.etherscore.json', title: 'Emergence (Original Composition)' },
        { path: 'examples/dynamics-showcase.etherscore.json', title: 'Dynamics Showcase (v0.4 Feature)' },
        { path: 'examples/fm-showcase.etherscore.json', title: 'FM Synthesis Showcase (v0.3 Feature)' },
        { path: 'examples/drum-kit-demo.etherscore.json', title: 'Drum Kit Demo (v0.2 Feature)' },
        { path: 'examples/euclidean-demo.etherscore.json', title: 'Euclidean Rhythms Demo (v0.2 Feature)' },
        { path: 'examples/arpeggiator-demo.etherscore.json', title: 'Enhanced Arpeggiator Demo (v0.2 Feature)' },
        { path: 'examples/llm-composition.etherscore.json', title: 'Reflections in Binary (Ambient)' },
        { path: 'examples/reflections-reprise.etherscore.json', title: 'Reflections in Binary - Reprise (Ambient)' },
        { path: 'examples/electronic-beat.etherscore.json', title: 'Digital Pulse (Electronic)' },
        { path: 'examples/jazz-standard.etherscore.json', title: 'Late Night Jazz (Jazz)' },
        { path: 'examples/ambient-journey.etherscore.json', title: 'Ambient Journey (Ambient)' },
        { path: 'examples/fugue-d-minor.etherscore.json', title: 'Fugue in D Minor (Baroque)' },
        { path: 'examples/house-midnight.etherscore.json', title: 'Midnight Protocol (House)' },
        { path: 'examples/synthwave-neon.etherscore.json', title: 'Neon Drift (Synthwave)' },
        { path: 'examples/boombap-dusty.etherscore.json', title: 'Dusty Crates (Boom Bap)' },
        { path: 'examples/vaporwave-plaza.etherscore.json', title: 'Vaporwave Plaza (Vaporwave)' },
      ];
    }

    // Populate song selectors
    async function populateSongSelectors() {
      const compositions = await loadCompositions();

      [songSelect, songSelectPlaying].forEach(select => {
        // Clear existing options
        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }
        // Add new options
        compositions.forEach(comp => {
          const option = document.createElement('option');
          option.value = comp.path;
          option.textContent = comp.title;
          select.appendChild(option);
        });
      });
    }

    // Format time as M:SS
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return mins + ':' + secs.toString().padStart(2, '0');
    }

    // Update play button icon (using trusted static SVG)
    function updatePlayIcon(state) {
      // Clear existing children
      while (playIcon.firstChild) {
        playIcon.removeChild(playIcon.firstChild);
      }
      // Create new SVG elements
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = '<svg>' + (state === 'playing' ? PAUSE_ICON : PLAY_ICON) + '</svg>';
      const newElements = tempDiv.querySelector('svg').childNodes;
      Array.from(newElements).forEach(node => {
        playIcon.appendChild(node.cloneNode(true));
      });
    }

    // Resize canvas to match display size
    function resizeNoteCanvas() {
      const rect = noteCanvas.getBoundingClientRect();
      noteCanvas.width = rect.width * window.devicePixelRatio;
      noteCanvas.height = rect.height * window.devicePixelRatio;
      noteCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    // Build track labels for current composition
    function buildTrackLabels(instrumentNames) {
      trackList = instrumentNames;

      // Assign colors to tracks
      trackColors = {};
      instrumentNames.forEach(function(name, i) {
        trackColors[name] = NOTE_COLORS[i % NOTE_COLORS.length];
      });

      // Clear and rebuild labels
      while (trackLabels.firstChild) {
        trackLabels.removeChild(trackLabels.firstChild);
      }

      instrumentNames.forEach(function(name) {
        const label = document.createElement('div');
        label.className = 'track-label';
        label.id = 'label-' + name;
        label.textContent = name;
        label.style.color = trackColors[name];
        trackLabels.appendChild(label);
      });

      resizeNoteCanvas();
    }

    // Trigger visual feedback for a track
    function triggerTrackActivity(name) {
      const label = document.getElementById('label-' + name);
      if (label) {
        label.classList.add('active');
        setTimeout(function() {
          label.classList.remove('active');
        }, 150);
      }
    }

    // Draw scrolling notes
    function drawNotes() {
      if (!player || !player.getTimeline()) return;

      const timeline = player.getTimeline();
      const currentTime = player.getPosition();
      const width = noteCanvas.width / window.devicePixelRatio;
      const height = noteCanvas.height / window.devicePixelRatio;

      // Clear canvas
      noteCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      noteCtx.fillRect(0, 0, width, height);

      // Draw track lanes
      const trackHeight = height / trackList.length;
      trackList.forEach(function(name, i) {
        const y = i * trackHeight;

        // Lane separator
        noteCtx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        noteCtx.fillRect(HIT_LINE_X, y, width - HIT_LINE_X, trackHeight);

        if (i > 0) {
          noteCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
          noteCtx.beginPath();
          noteCtx.moveTo(HIT_LINE_X, y);
          noteCtx.lineTo(width, y);
          noteCtx.stroke();
        }
      });

      // Draw hit line
      noteCtx.strokeStyle = '#64ffda';
      noteCtx.lineWidth = 2;
      noteCtx.shadowColor = '#64ffda';
      noteCtx.shadowBlur = 8;
      noteCtx.beginPath();
      noteCtx.moveTo(HIT_LINE_X, 0);
      noteCtx.lineTo(HIT_LINE_X, height);
      noteCtx.stroke();
      noteCtx.shadowBlur = 0;

      // Get all note events from timeline
      const allNotes = (timeline.events || []).filter(function(e) { return e.type === 'note'; });

      // Draw notes that are within the lookahead window
      allNotes.forEach(function(note) {
        const noteTime = note.timeSeconds;
        const relativeTime = noteTime - currentTime;

        // Only show notes within lookahead window and slightly past
        if (relativeTime < -0.1 || relativeTime > LOOKAHEAD_SECONDS) return;

        // Find track index
        const trackIndex = trackList.indexOf(note.instrument);
        if (trackIndex === -1) return;

        // Calculate position
        const progress = relativeTime / LOOKAHEAD_SECONDS;
        const x = HIT_LINE_X + progress * (width - HIT_LINE_X);
        const y = trackIndex * trackHeight + trackHeight / 2;

        // Note dimensions based on duration
        const noteWidth = Math.max(4, Math.min(30, note.durationSeconds * 40));
        const noteHeight = trackHeight * 0.6;

        // Get color for this track
        const color = trackColors[note.instrument] || '#64ffda';

        // Draw note
        noteCtx.fillStyle = color;
        noteCtx.globalAlpha = relativeTime < 0 ? 0.3 : 0.8;
        noteCtx.beginPath();
        noteCtx.roundRect(x - noteWidth / 2, y - noteHeight / 2, noteWidth, noteHeight, 3);
        noteCtx.fill();

        // Glow effect for notes about to hit
        if (relativeTime < 0.1 && relativeTime > -0.05) {
          noteCtx.shadowColor = color;
          noteCtx.shadowBlur = 12;
          noteCtx.fill();
          noteCtx.shadowBlur = 0;
        }

        noteCtx.globalAlpha = 1;
      });

      if (player.getState() === 'playing') {
        animationId = requestAnimationFrame(drawNotes);
      }
    }

    // Start note animation
    function startNoteAnimation() {
      if (animationId) cancelAnimationFrame(animationId);
      drawNotes();
    }

    // Stop note animation
    function stopNoteAnimation() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      // Draw static frame
      if (player) drawNotes();
    }

    // Load and display a composition
    async function loadComposition(path) {
      // Determine which error element to use based on current UI state
      const errorEl = playerUI.style.display === 'block' ? playerError : loadError;

      try {
        // Hide any previous errors
        loadError.style.display = 'none';
        playerError.style.display = 'none';

        console.log('Loading composition:', path);

        const response = await fetch(path);
        if (!response.ok) throw new Error('Failed to load: ' + path);

        const score = await response.json();
        console.log('Score loaded, calling player.load...');

        await player.load(score);
        console.log('Player loaded successfully');

        // Update UI with metadata (check both top-level and meta object for backwards compatibility)
        const meta = score.meta || {};
        document.getElementById('song-title').textContent = score.title || meta.title || 'Untitled';
        document.getElementById('song-composer').textContent = (score.composer || meta.composer) ? 'by ' + (score.composer || meta.composer) : '';
        document.getElementById('song-tempo').textContent = score.settings.tempo + ' BPM';
        document.getElementById('song-key').textContent = score.settings.key || '';
        document.getElementById('song-duration').textContent = formatTime(player.getDuration());
        document.getElementById('song-description').textContent = score.description || meta.description || '';
        totalTimeEl.textContent = formatTime(player.getDuration());

        // Build track labels and instrument chips
        const instruments = player.getInstruments();
        buildTrackLabels(instruments);

        while (instrumentsEl.firstChild) {
          instrumentsEl.removeChild(instrumentsEl.firstChild);
        }
        instruments.forEach(name => {
          const chip = document.createElement('span');
          chip.className = 'instrument';
          chip.id = 'inst-' + name;
          chip.textContent = name;
          instrumentsEl.appendChild(chip);
        });

        // Reset progress
        progressFill.style.width = '0%';
        currentTimeEl.textContent = '0:00';
        sectionDisplay.textContent = '';

        // Build section buttons
        const sections = player.getSections();
        buildSectionButtons(sections);

        // Reset tempo to 100%
        tempoSlider.value = 100;
        updateTempoDisplay(1.0);

        // Sync both selectors
        songSelect.value = path;
        songSelectPlaying.value = path;

        console.log('UI updated for:', meta.title);

      } catch (error) {
        console.error('Error loading composition:', error);
        errorEl.textContent = 'Error: ' + error.message;
        errorEl.style.display = 'block';
      }
    }

    // Initialize player
    async function initPlayer() {
      player = EtherDAW.createPlayer();

      // Set up callbacks
      player.setCallbacks({
        onStateChange: function(state) {
          updatePlayIcon(state);
          if (state === 'playing') {
            startNoteAnimation();
          } else {
            stopNoteAnimation();
          }
        },
        onProgress: function(current, total) {
          const percent = (current / total) * 100;
          progressFill.style.width = percent + '%';
          currentTimeEl.textContent = formatTime(current);
        },
        onSectionChange: function(section) {
          sectionDisplay.textContent = section.replace(/_/g, ' ');
          updateActiveSectionButton(section);
        },
        onInstrumentPlay: function(instrument) {
          // Trigger meter activity
          triggerTrackActivity(instrument);

          // Also update instrument chips
          const chip = document.getElementById('inst-' + instrument);
          if (chip) {
            chip.classList.add('active');
            setTimeout(function() { chip.classList.remove('active'); }, 200);
          }
        },
        onError: function(error) {
          console.error('Player error:', error);
          loadError.textContent = 'Error: ' + error.message;
          loadError.style.display = 'block';
        },
      });

      // Load selected composition
      await loadComposition(songSelect.value);

      // Set initial volume
      updateVolume(parseInt(volumeSlider.value));

      // Show player UI
      loadingEl.style.display = 'none';
      playerUI.style.display = 'block';

      // Resize canvas now that UI is visible
      resizeNoteCanvas();
    }

    // Create SVG path element safely
    function createSvgPath(d, attrs) {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', d);
      if (attrs) {
        Object.entries(attrs).forEach(function(entry) {
          path.setAttribute(entry[0], entry[1]);
        });
      }
      return path;
    }

    // Create SVG line element safely
    function createSvgLine(x1, y1, x2, y2, attrs) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      if (attrs) {
        Object.entries(attrs).forEach(function(entry) {
          line.setAttribute(entry[0], entry[1]);
        });
      }
      return line;
    }

    // Update volume and icon
    function updateVolume(value) {
      if (!player) return;

      volumeDisplay.textContent = value + '%';

      // Convert percentage to linear (0-1)
      const linear = value / 100;
      player.setVolumeLinear(linear);

      // Update icon based on volume level
      updateVolumeIcon(value, player.isMuted());
    }

    // Update volume icon using safe DOM methods
    function updateVolumeIcon(value, isMuted) {
      // Clear existing icon content
      while (volumeIcon.firstChild) {
        volumeIcon.removeChild(volumeIcon.firstChild);
      }

      // Speaker base (always present)
      volumeIcon.appendChild(createSvgPath('M11 5L6 9H2v6h4l5 4V5z'));

      if (isMuted || value === 0) {
        // Muted - X lines
        volumeIcon.appendChild(createSvgLine(23, 9, 17, 15, { stroke: 'currentColor', 'stroke-width': '2' }));
        volumeIcon.appendChild(createSvgLine(17, 9, 23, 15, { stroke: 'currentColor', 'stroke-width': '2' }));
        muteBtn.classList.add('muted');
      } else if (value < 50) {
        // Low volume - one arc
        volumeIcon.appendChild(createSvgPath('M15.54 8.46a5 5 0 0 1 0 7.07', { stroke: 'currentColor', 'stroke-width': '2', fill: 'none' }));
        muteBtn.classList.remove('muted');
      } else {
        // High volume - two arcs
        volumeIcon.appendChild(createSvgPath('M15.54 8.46a5 5 0 0 1 0 7.07', { stroke: 'currentColor', 'stroke-width': '2', fill: 'none' }));
        volumeIcon.appendChild(createSvgPath('M19.07 4.93a10 10 0 0 1 0 14.14', { stroke: 'currentColor', 'stroke-width': '2', fill: 'none' }));
        muteBtn.classList.remove('muted');
      }
    }

    // Build section buttons from composition sections
    function buildSectionButtons(sections) {
      // Clear existing buttons
      while (sectionButtonsEl.firstChild) {
        sectionButtonsEl.removeChild(sectionButtonsEl.firstChild);
      }

      sections.forEach(function(section, index) {
        const btn = document.createElement('button');
        btn.className = 'section-btn';
        btn.dataset.index = index;
        btn.dataset.startTime = section.startTime;

        // Add keyboard shortcut hint for first 9 sections
        const indexSpan = document.createElement('span');
        indexSpan.className = 'section-index';
        if (index < 9) {
          indexSpan.textContent = (index + 1) + ':';
        }
        btn.appendChild(indexSpan);

        const nameText = document.createTextNode(section.name.replace(/_/g, ' '));
        btn.appendChild(nameText);

        btn.addEventListener('click', function() {
          if (!player) return;
          const startTime = parseFloat(this.dataset.startTime);
          player.seek(startTime);
          // Auto-play when clicking section
          if (player.getState() !== 'playing') {
            player.play();
          }
        });

        sectionButtonsEl.appendChild(btn);
      });
    }

    // Update active section button
    function updateActiveSectionButton(sectionName) {
      const buttons = sectionButtonsEl.querySelectorAll('.section-btn');
      buttons.forEach(function(btn) {
        const btnName = btn.textContent.replace(/^\d:/, '').trim();
        const sectionNameClean = sectionName.replace(/_/g, ' ');
        if (btnName === sectionNameClean) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Update tempo display
    function updateTempoDisplay(rate) {
      const percent = Math.round(rate * 100);
      tempoDisplayEl.textContent = percent + '%';
    }

    // Handle tempo slider change
    function handleTempoChange(value) {
      if (!player) return;
      // Slider goes 50-200, representing 0.5x to 2.0x
      const rate = value / 100;
      player.setPlaybackRate(rate);
      updateTempoDisplay(rate);
    }

    // Get sections array from player
    function getSections() {
      if (!player) return [];
      return player.getSections();
    }

    // Toggle mute
    function toggleMute() {
      if (!player) return;

      const isMuted = player.isMuted();
      if (isMuted) {
        // Unmute - restore previous volume
        player.setMuted(false);
        volumeSlider.value = lastVolumeBeforeMute;
        updateVolume(lastVolumeBeforeMute);
      } else {
        // Mute - save current volume
        lastVolumeBeforeMute = parseInt(volumeSlider.value);
        player.setMuted(true);
        updateVolumeIcon(0, true);
      }
    }

    // Event listeners
    startBtn.addEventListener('click', initPlayer);

    playBtn.addEventListener('click', function() {
      if (!player) return;
      const state = player.getState();
      if (state === 'playing') {
        player.pause();
      } else {
        player.play();
      }
    });

    stopBtn.addEventListener('click', function() {
      if (player) player.stop();
    });

    volumeSlider.addEventListener('input', function(e) {
      updateVolume(parseInt(e.target.value));
    });

    muteBtn.addEventListener('click', toggleMute);

    tempoSlider.addEventListener('input', function(e) {
      handleTempoChange(parseInt(e.target.value));
    });

    progressBar.addEventListener('click', function(e) {
      if (!player) return;
      const rect = progressBar.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const seekTime = percent * player.getDuration();
      player.seek(seekTime);
    });

    songSelectPlaying.addEventListener('change', async function(e) {
      console.log('Song selector changed to:', e.target.value);
      if (player) {
        player.stop();
        await loadComposition(e.target.value);
      } else {
        console.error('Player not initialized');
      }
    });

    exportBtn.addEventListener('click', async function() {
      if (!player) return;

      exportBtn.disabled = true;
      const originalText = exportBtn.querySelector('svg');

      try {
        // Show loading state
        const loadingSpan = document.createElement('span');
        loadingSpan.style.fontSize = '10px';
        loadingSpan.textContent = 'Rendering...';
        while (exportBtn.firstChild) exportBtn.removeChild(exportBtn.firstChild);
        exportBtn.appendChild(loadingSpan);

        const wavData = await player.renderToWav();
        const blob = new Blob([wavData], { type: 'audio/wav' });
        const url = URL.createObjectURL(blob);

        const score = player.getScore();
        const filename = ((score && score.meta && score.meta.title) || 'composition').replace(/[^a-z0-9]/gi, '_') + '.wav';

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();

        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed: ' + error.message);
      } finally {
        exportBtn.disabled = false;
        // Restore export button
        while (exportBtn.firstChild) exportBtn.removeChild(exportBtn.firstChild);
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');
        svg.innerHTML = '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>';
        exportBtn.appendChild(svg);
      }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      resizeNoteCanvas();
      if (player) drawNotes();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ignore if typing in an input field
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      if (!player) return;

      switch (e.key) {
        case ' ': // Space - play/pause
          e.preventDefault();
          if (player.getState() === 'playing') {
            player.pause();
          } else {
            player.play();
          }
          break;

        case 'ArrowLeft': // Seek back 5s
          e.preventDefault();
          const newPosBack = Math.max(0, player.getPosition() - 5);
          player.seek(newPosBack);
          break;

        case 'ArrowRight': // Seek forward 5s
          e.preventDefault();
          const newPosFwd = Math.min(player.getDuration(), player.getPosition() + 5);
          player.seek(newPosFwd);
          break;

        case 'Home': // Go to start
          e.preventDefault();
          player.seek(0);
          break;

        case 'End': // Go to end (near end)
          e.preventDefault();
          player.seek(Math.max(0, player.getDuration() - 1));
          break;

        case '1': case '2': case '3': case '4': case '5':
        case '6': case '7': case '8': case '9':
          // Jump to section by number
          e.preventDefault();
          const sectionIndex = parseInt(e.key) - 1;
          const sections = getSections();
          if (sectionIndex < sections.length) {
            player.seek(sections[sectionIndex].startTime);
            if (player.getState() !== 'playing') {
              player.play();
            }
          }
          break;

        case 'm': case 'M': // Mute toggle
          e.preventDefault();
          toggleMute();
          break;
      }
    });

    // Initialize song selector
    populateSongSelectors();
  </script>
</body>
</html>
